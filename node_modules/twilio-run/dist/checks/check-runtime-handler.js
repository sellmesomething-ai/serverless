"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.checkForValidRuntimeHandlerVersion = exports.isExactSemVerVersion = void 0;
const common_tags_1 = require("common-tags");
const semver_1 = require("semver");
const logger_1 = require("../utils/logger");
function isExactSemVerVersion(version) {
    return (0, semver_1.parse)(version) !== null;
}
exports.isExactSemVerVersion = isExactSemVerVersion;
function checkForValidRuntimeHandlerVersion(packageJson, shouldFailIfMissing = false) {
    var _a, _b;
    const runtimeHandlerVersion = (_a = packageJson.dependencies) === null || _a === void 0 ? void 0 : _a['@twilio/runtime-handler'];
    let title;
    let message;
    if (typeof runtimeHandlerVersion !== 'string') {
        if ((_b = packageJson.devDependencies) === null || _b === void 0 ? void 0 : _b['@twilio/runtime-handler']) {
            title = 'Wrongly configured @twilio/runtime-handler declaration';
            message = (0, common_tags_1.stripIndent) `
      You defined the @twilio/runtime-handler dependency inside the "devDependencies" field of your package.json.

      The @twilio/runtime-handler has to be defined in the "dependencies" field instead to be passed to Twilio Functions.
    `;
        }
        else if (shouldFailIfMissing) {
            title = 'Missing @twilio/runtime-handler declaration';
            message = (0, common_tags_1.stripIndent) `
        We could not find a specific @twilio/runtime-handler version in your package.json "dependencies" field.

        The @twilio/runtime-handler defines which features inside your Twilio Functions environment should be available.

        Please add one manually or run the following inside your project to install the latest version of the @twilio/runtime-handler:

        npm install @twilio/runtime-handler --save-exact
      `;
        }
        else {
            return true;
        }
    }
    else if (isExactSemVerVersion(runtimeHandlerVersion)) {
        return true;
    }
    else {
        title = 'Invalid @twilio/runtime-handler version';
        message = (0, common_tags_1.stripIndent) `
      The @twilio/runtime-handler version has to be an exact valid semver version.
      Please update the "dependencies" field in your package.json accordingly.

      Received:
        "@twilio/runtime-handler": "${runtimeHandlerVersion}",
      Expected Format:
        "@twilio/runtime-handler": "${(0, semver_1.coerce)(runtimeHandlerVersion) || '1.1.0'}",
    `;
    }
    if (message) {
        logger_1.logger.error(message, title);
    }
    return false;
}
exports.checkForValidRuntimeHandlerVersion = checkForValidRuntimeHandlerVersion;
